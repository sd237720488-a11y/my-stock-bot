<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®è§‚é£æ§ (Mobile V7.3 ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.staticfile.org/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        :root {
            --bg: #111827; --card: #1f2937; --text: #f3f4f6; --muted: #9ca3af;
            --primary: #3b82f6; --green: #10b981; --red: #ef4444; --orange: #f59e0b;
            --gold: #fbbf24;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: -apple-system, Helvetica, sans-serif; 
            margin: 0; padding: 16px; padding-bottom: 100px;
        }

        /* é¡¶éƒ¨ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .title { font-size: 18px; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 8px; }
        
        /* æ•°æ®æºçŠ¶æ€èƒ¶å›Š */
        .source-pill { 
            font-size: 11px; padding: 4px 10px; border-radius: 20px; 
            font-weight: bold; display: flex; align-items: center; gap: 6px;
            background: #374151; color: #9ca3af; border: 1px solid #4b5563;
        }
        .source-pill.live { background: rgba(16, 185, 129, 0.15); color: var(--green); border-color: var(--green); }
        .source-pill.cache { background: rgba(245, 158, 11, 0.15); color: var(--orange); border-color: var(--orange); }
        .source-pill.manual { background: rgba(168, 85, 247, 0.15); color: #c084fc; border-color: #a855f7; }

        .refresh-btn { background: var(--primary); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; font-size: 16px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .refresh-btn:active { transform: scale(0.9); }
        .refresh-btn.spinning { animation: spin 1s linear infinite; opacity: 0.7; pointer-events: none; }

        /* æ ¸å¿ƒå¤§è¡¨ç›˜ */
        .score-card { 
            background: linear-gradient(145deg, #1f2937, #111827); 
            border: 1px solid #374151; border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 24px; 
            position: relative; overflow: hidden; transition: border-color 0.3s;
        }
        .score-val { font-size: 64px; font-weight: 900; line-height: 1; margin-bottom: 8px; letter-spacing: -2px; }
        .score-label { font-size: 13px; color: var(--muted); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
        .score-advice { margin-top: 16px; font-size: 15px; font-weight: bold; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
        
        .st-safe { color: var(--green); border-color: var(--green); }
        .st-warn { color: var(--orange); border-color: var(--orange); }
        .st-danger { color: var(--red); border-color: var(--red); animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* ç­–ç•¥æ¡ */
        .strategy-bar { margin-top: 16px; display: flex; gap: 8px; justify-content: center; }
        .strat-tag { font-size: 12px; padding: 6px 12px; border-radius: 20px; font-weight: bold; background: #374151; color: #9ca3af; border: 1px solid transparent; }
        .strat-active { background: rgba(16, 185, 129, 0.15); color: var(--green); border-color: var(--green); }
        .strat-gold { background: rgba(251, 191, 36, 0.15); color: var(--gold); border-color: var(--gold); }
        .strat-cash { background: rgba(59, 130, 246, 0.15); color: var(--primary); border-color: var(--primary); }

        /* æŒ‡æ ‡åˆ—è¡¨ */
        .metric-card { 
            background: var(--card); border-radius: 12px; padding: 16px; margin-bottom: 12px; 
            display: flex; align-items: flex-start; justify-content: space-between;
            border-left: 4px solid transparent; position: relative; transition: opacity 0.3s;
        }
        .metric-card.loading { opacity: 0.5; }
        .m-left { display: flex; flex-direction: column; flex: 1; margin-right: 10px; }
        
        .m-title { font-size: 13px; color: #e5e7eb; font-weight: 700; margin-bottom: 2px; display:flex; align-items:center; gap:6px;}
        .source-link { font-size: 10px; color: #60a5fa; text-decoration: none; opacity: 0.7; }
        
        /* ä¼˜åŒ–åçš„è§£é‡Šæ–‡å­— */
        .m-desc { font-size: 11px; color: #9ca3af; line-height: 1.5; margin-top: 6px; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px; }
        
        .m-value { font-size: 20px; font-weight: 700; font-family: monospace; color: #fff; margin-top: 2px; }
        .m-sub-value { font-size: 12px; color: #9ca3af; font-weight: normal; margin-left: 6px; }
        .m-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .m-badge { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: bold; background: #374151; color: #9ca3af; white-space: nowrap; }
        .edit-icon { font-size: 12px; opacity: 0.5; }

        .bd-safe { background: rgba(16, 185, 129, 0.2); color: var(--green); }
        .bd-warn { background: rgba(245, 158, 11, 0.2); color: var(--orange); }
        .bd-danger { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .bd-blue { background: rgba(59, 130, 246, 0.2); color: var(--primary); }

        /* å†å²è­¦ç¤º */
        .history-box { background: #18202f; border-radius: 12px; padding: 16px; margin-top: 24px; border: 1px dashed #374151; }
        .h-title { font-size: 13px; font-weight: bold; color: var(--muted); margin-bottom: 12px; }
        .crash-row { display: flex; align-items: center; margin-bottom: 10px; }
        .crash-year { width: 40px; font-size: 12px; font-weight: bold; color: #6b7280; }
        .crash-track { flex: 1; height: 8px; background: #374151; border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .crash-fill { height: 100%; background: var(--red); border-radius: 4px; }
        .crash-val { width: 40px; font-size: 12px; font-weight: bold; color: var(--red); text-align: right; }

        /* åº•éƒ¨ä¸é¢æ¿ */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #111827; border-top: 1px solid #374151; padding: 12px 20px; display: flex; gap: 12px; z-index: 90; }
        .action-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 14px; cursor: pointer; }
        .btn-api { background: #1f2937; color: var(--text); border: 1px solid #374151; }
        .btn-reset { background: #1f2937; color: var(--red); border: 1px solid #374151; }

        .settings-panel { 
            background: #111827; border-top: 1px solid #374151; position: fixed; bottom: 0; left: 0; right: 0; 
            padding: 20px; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s;
            z-index: 100; max-height: 85vh; overflow-y: auto; 
        }
        .settings-panel.open { transform: translateY(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; display: none; }
        .overlay.open { display: block; }
        
        .section-title { font-size: 12px; color: var(--primary); font-weight: bold; margin: 15px 0 8px 0; border-bottom: 1px solid #374151; padding-bottom: 4px; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .input-group { display: flex; flex-direction: column; }
        .input-label { font-size: 11px; color: var(--muted); margin-bottom: 6px; }
        .fab-settings { position: fixed; bottom: 20px; right: 20px; width: 48px; height: 48px; background: #374151; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 90; color: #fff; font-size: 24px; border: 1px solid #4b5563; }
        
        /* å¼¹çª— */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: #1f2937; width: 85%; max-width: 320px; border-radius: 16px; padding: 20px; border: 1px solid #374151; }
        .modal-title { font-size: 16px; font-weight: bold; margin-bottom: 16px; color: white; }
        .modal input { width: 100%; background: #111827; border: 1px solid #374151; color: white; padding: 12px; border-radius: 8px; font-size: 20px; text-align: center; margin-bottom: 16px; outline: none; }
        .modal-btns { display: flex; gap: 10px; }
        .btn-cancel, .btn-save { flex: 1; padding: 10px; border-radius: 8px; font-weight: bold; border: none; }
        .btn-cancel { background: transparent; border: 1px solid #374151; color: var(--muted); }
        .btn-save { background: var(--primary); color: white; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- 1. é¡¶éƒ¨ (æ–°å¢æ•°æ®çŠ¶æ€) -->
    <div class="header">
        <div class="title">
            <div id="dataStatusPill" class="source-pill">âšªï¸ ç¦»çº¿å¿«ç…§</div>
        </div>
        <button class="refresh-btn" onclick="fetchData(true)" id="btnRefresh">ğŸ”„</button>
    </div>

    <!-- 2. å¤§è¡¨ç›˜ -->
    <div class="score-card" id="mainCard">
        <div class="score-label">å½“å‰å®è§‚é£é™©æŒ‡æ•°</div>
        <div class="score-val" id="disp_score">--</div>
        
        <div class="strategy-bar" id="strategyBar">
            <div class="strat-tag" id="st_stock">è‚¡ç¥¨</div>
            <div class="strat-tag" id="st_bond">å›½å€º</div>
            <div class="strat-tag" id="st_cash">ç°é‡‘</div>
            <div class="strat-tag" id="st_gold">é»„é‡‘</div>
        </div>
        <div id="adviceText" style="margin-top:12px; font-size:12px; color:#9ca3af;">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <!-- 3. æŒ‡æ ‡åˆ—è¡¨ -->
    <div id="metricsList">
        
        <!-- ç¾è”å‚¨åˆ©ç‡ -->
        <div class="metric-card" id="card_fed" onclick="openEdit('fed')">
            <div class="m-left">
                <div class="m-title">
                    ğŸ‡ºğŸ‡¸ è”é‚¦åŸºé‡‘åˆ©ç‡ 
                    <a href="https://fred.stlouisfed.org/series/FEDFUNDS" target="_blank" class="source-link" onclick="event.stopPropagation()">ğŸ”—</a>
                    <span class="edit-icon">âœï¸</span>
                </div>
                <div class="m-value" id="val_fed">--%</div>
                <div class="m-desc">èµ„äº§å®šä»·ä¹‹é”šã€‚é«˜æ¯æ”¶æ°´ï¼Œä½æ¯æ”¾æ°´ã€‚</div>
            </div>
            <div class="m-right"><div class="m-badge bd-blue" id="badge_fed">ç­‰å¾…</div></div>
        </div>

        <!-- è¨å§†è§„åˆ™ -->
        <div class="metric-card" id="card_sahm" onclick="openEdit('sahm')">
            <div class="m-left">
                <div class="m-title">
                    ğŸ›‘ è¨å§†è§„åˆ™ (å¤±ä¸šç‡)
                    <a href="https://fred.stlouisfed.org/series/UNRATE" target="_blank" class="source-link" onclick="event.stopPropagation()">ğŸ”—</a>
                    <span class="edit-icon">âœï¸</span>
                </div>
                <div class="m-value">
                    <span id="val_sahm_diff" title="åå¼¹å¹…åº¦">--%</span>
                    <span class="m-sub-value" id="val_sahm_raw" title="å½“å‰å¤±ä¸šç‡"></span>
                </div>
                <div class="m-desc">çœ‹å¤±ä¸šç‡åå¼¹å¹…åº¦ã€‚å¦‚æœæ¯”è¿‡å»1å¹´æœ€ä½ç‚¹<strong>ä¸Šæ¶¨ >0.5%</strong>ï¼Œè¯´æ˜ç»æµå·²è¿›å…¥è¡°é€€ã€‚</div>
            </div>
            <div class="m-right"><div class="m-badge" id="badge_sahm">ç­‰å¾…</div></div>
        </div>

        <!-- ç¾å€ºåˆ©å·® -->
        <div class="metric-card" id="card_yield" onclick="openEdit('yield')">
            <div class="m-left">
                <div class="m-title">
                    ğŸ¦ ç¾å€ºåˆ©å·® (10Y-2Y)
                    <a href="https://fred.stlouisfed.org/series/T10Y2Y" target="_blank" class="source-link" onclick="event.stopPropagation()">ğŸ”—</a>
                    <span class="edit-icon">âœï¸</span>
                </div>
                <div class="m-value" id="val_yield">--%</div>
                <div class="m-desc" id="desc_yield">è´Ÿå€¼(å€’æŒ‚)æ˜¯å±é™©å‰å…†ã€‚æœ€è‡´å‘½çš„æ˜¯å€’æŒ‚å¾ˆä¹…å<strong>çªç„¶å›æ­£(å˜çº¢)</strong>ï¼Œé€šå¸¸å¯¹åº”å´©ç›˜å¼€å§‹ã€‚</div>
            </div>
            <div class="m-right"><div class="m-badge" id="badge_yield">ç­‰å¾…</div></div>
        </div>

        <!-- CPI é€šèƒ€ -->
        <div class="metric-card" id="card_cpi" onclick="openEdit('cpi')">
            <div class="m-left">
                <div class="m-title">
                    ğŸ’¸ CPI é€šèƒ€ (åŒæ¯”)
                    <a href="https://fred.stlouisfed.org/series/CPIAUCSL" target="_blank" class="source-link" onclick="event.stopPropagation()">ğŸ”—</a>
                    <span class="edit-icon">âœï¸</span>
                </div>
                <div class="m-value" id="val_cpi">--%</div>
                <div class="m-desc">ç‰©ä»·æ¶¨å¹…ã€‚<strong>>3%</strong> å¤®è¡Œä¸æ•¢é™æ¯ï¼›<strong>>5%</strong> ç°é‡‘è´¬å€¼(æ»èƒ€)ï¼Œè‚¡å€ºåŒæ€ã€‚</div>
            </div>
            <div class="m-right"><div class="m-badge" id="badge_cpi">ç­‰å¾…</div></div>
        </div>

        <!-- è¾…åŠ©æŒ‡æ ‡ -->
        <div class="metric-card manual" style="border-left-color: #a855f7;" onclick="openEdit('buffett')">
            <div class="m-left">
                <div class="m-title">
                    ğŸ” å·´è²ç‰¹æŒ‡æ ‡
                    <a href="https://www.currentmarketvaluation.com/" target="_blank" class="source-link" onclick="event.stopPropagation()">ğŸ”—</a>
                    <span class="edit-icon">âœï¸</span>
                </div>
                <div class="m-value" id="val_buffett">--%</div>
                <div class="m-desc">ç¾è‚¡æ€»å¸‚å€¼ Ã· GDPã€‚<strong>>150%</strong> åè´µï¼Œ<strong>>200%</strong> ä¸¥é‡æ³¡æ²«(æ€§ä»·æ¯”æä½)ã€‚</div>
            </div>
            <div class="m-right"><div class="m-badge" id="badge_buffett">æ‰‹åŠ¨</div></div>
        </div>

        <div class="metric-card manual" style="border-left-color: var(--green);" onclick="openEdit('fear')">
            <div class="m-left">
                <div class="m-title">
                    ğŸ˜¨ ææ…Œè´ªå©ªæŒ‡æ•°
                    <a href="https://edition.cnn.com/markets/fear-and-greed" target="_blank" class="source-link" onclick="event.stopPropagation()">ğŸ”—</a>
                    <span class="edit-icon">âœï¸</span>
                </div>
                <div class="m-value" id="val_fear">--</div>
                <div class="m-desc"><strong>&lt;25</strong> ææ(æ­¤æ—¶ä¹°å…¥èƒœç‡é«˜)ï¼Œ<strong>>75</strong> æè´ª(æ­¤æ—¶è¿½é«˜å®¹æ˜“è¢«å¥—)ã€‚</div>
            </div>
            <div class="m-right"><div class="m-badge" id="badge_fear">æ‰‹åŠ¨</div></div>
        </div>
    </div>

    <!-- 4. å†å²è­¦ç¤º -->
    <div class="history-box">
        <div class="h-title">ğŸ“‰ å†å²çº¢ç¯åçš„ç»“å±€ (çº³æŒ‡æœ€å¤§å›æ’¤)</div>
        <div class="crash-row">
            <div class="crash-year">2000</div>
            <div class="crash-track"><div class="crash-fill" style="width: 78%"></div></div>
            <div class="crash-val">-78%</div>
        </div>
        <div class="crash-row">
            <div class="crash-year">2008</div>
            <div class="crash-track"><div class="crash-fill" style="width: 50%"></div></div>
            <div class="crash-val">-50%</div>
        </div>
        <div class="crash-row">
            <div class="crash-year">2020</div>
            <div class="crash-track"><div class="crash-fill" style="width: 34%"></div></div>
            <div class="crash-val">-34%</div>
        </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="bottom-bar">
        <button class="action-btn btn-reset" onclick="clearData()">ğŸ§¹ æ¸…ç©º</button>
        <button class="action-btn btn-api" onclick="fetchData(true)">ğŸ“¡ å¼ºåˆ¶åˆ·æ–°</button>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div class="fab-settings" onclick="toggleSettings()">âš™ï¸</div>
    <div class="overlay" onclick="toggleSettings()" id="overlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3 style="margin:0; color:#fff;">ğŸ”§ æ•°æ®æ ¡å‡†</h3>
            <span onclick="toggleSettings()" style="color:var(--primary);">å®Œæˆ</span>
        </div>
        <div class="input-group">
            <label class="input-label">Alpha Vantage API Key</label>
            <input type="text" id="apiKey" value="O0VQP18WF8I5N66X">
        </div>
        
        <div class="section-title">æ ¸å¿ƒå®è§‚ (è‡ªåŠ¨)</div>
        <div class="input-row">
            <div class="input-group"><label class="input-label">ç¾è”å‚¨åˆ©ç‡ (%)</label><input type="number" id="inp_fed" step="0.25" oninput="calc('manual')"></div>
            <div class="input-group"><label class="input-label">CPI é€šèƒ€ (%)</label><input type="number" id="inp_cpi" step="0.1" oninput="calc('manual')"></div>
        </div>
        
        <!-- è¨å§†æ‹†åˆ† (Label å·²ä¿®æ­£) -->
        <div class="input-row">
            <div class="input-group"><label class="input-label">å½“å‰å¤±ä¸šç‡ (%)</label><input type="number" id="inp_sahm_cur" step="0.1" oninput="calc('manual')"></div>
            <div class="input-group"><label class="input-label">è¿‡å»12æœˆæœ€ä½ (%)</label><input type="number" id="inp_sahm_low" step="0.1" oninput="calc('manual')"></div>
        </div>

        <div class="input-row">
            <div class="input-group"><label class="input-label">ç¾å€ºåˆ©å·® (%)</label><input type="number" id="inp_yield" step="0.01" oninput="calc('manual')"></div>
            <div class="input-group"><label class="input-label" style="color:orange">æ›¾å€’æŒ‚ (1=æ˜¯)</label><input type="number" id="inp_was_inverted" value="0" oninput="calc('manual')"></div>
        </div>

        <div class="section-title">è¾…åŠ©æ•°æ® (æ‰‹åŠ¨)</div>
        <div class="input-row">
            <div class="input-group"><label class="input-label">å·´è²ç‰¹ (%)</label><input type="number" id="inp_buffett" value="221.7" oninput="calc('manual')"></div>
            <div class="input-group"><label class="input-label">ææ…Œ (0-100)</label><input type="number" id="inp_fear" value="52" oninput="calc('manual')"></div>
        </div>
    </div>

    <!-- å¼¹çª— -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-title" id="modalTitle">ä¿®æ”¹æ•°å€¼</div>
            <input type="number" id="modalInput" step="0.1">
            <div id="sahmInputs" style="display:none; gap:10px; flex-direction:column; margin-bottom:16px;">
                <input type="number" id="modalSahmCur" placeholder="å½“å‰å¤±ä¸šç‡" step="0.1">
                <input type="number" id="modalSahmLow" placeholder="è¿‡å»12æœˆæœ€ä½" step="0.1">
            </div>
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeEdit()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="saveEdit()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- éšè—å­˜å‚¨ -->
    <div id="dataStore" style="display:none;" data-fed="" data-yield="" data-cpi="" data-buffett="" data-fear="" data-was-inverted="0"></div>

    <script>
        const getEl = (id) => document.getElementById(id);
        const CACHE_KEY = "macro_data_v73"; 

        // é»˜è®¤å¿«ç…§ (2026å¹´1æœˆè¿‘ä¼¼å€¼)
        const SNAPSHOT = {
            fed: 4.5,
            sahm_cur: 4.1, sahm_low: 3.7,
            yield: 0.15, inverted: 1,
            cpi: 3.2,
            buffett: 221.7, fear: 52
        };
        
        function setStatusPill(type) {
            const pill = getEl('dataStatusPill');
            if (type === 'live') { pill.innerText = "ğŸŸ¢ å®æ—¶æ•°æ® (API)"; pill.className = "source-pill live"; }
            else if (type === 'cache') { pill.innerText = "ğŸŸ¡ ç¼“å­˜æ•°æ® (24h)"; pill.className = "source-pill cache"; }
            else if (type === 'manual') { pill.innerText = "ğŸŸ£ æ‰‹åŠ¨/ä¿®æ”¹"; pill.className = "source-pill manual"; }
            else { pill.innerText = "âšªï¸ ç¦»çº¿å¿«ç…§"; pill.className = "source-pill"; }
        }

        // --- æ ¸å¿ƒè®¡ç®— ---
        function calc(sourceType) {
            if (sourceType) setStatusPill(sourceType);

            const fedInput = getEl('inp_fed');
            const fed = fedInput ? parseFloat(fedInput.value) : NaN;
            
            const sahmCurInput = getEl('inp_sahm_cur');
            const sCur = sahmCurInput ? parseFloat(sahmCurInput.value) : NaN;
            
            const sahmLowInput = getEl('inp_sahm_low');
            const sLow = sahmLowInput ? parseFloat(sahmLowInput.value) : NaN;
            
            const sahmDiff = (!isNaN(sCur) && !isNaN(sLow)) ? (sCur - sLow) : NaN;

            const yieldInput = getEl('inp_yield');
            const spread = yieldInput ? parseFloat(yieldInput.value) : NaN;
            
            const cpiInput = getEl('inp_cpi');
            const cpi = cpiInput ? parseFloat(cpiInput.value) : NaN;
            
            const buffettInput = getEl('inp_buffett');
            const buffett = buffettInput ? parseFloat(buffettInput.value) : NaN;
            
            const fearInput = getEl('inp_fear');
            const fear = fearInput ? parseFloat(fearInput.value) : NaN;
            
            const invertedInput = getEl('inp_was_inverted');
            const wasInverted = invertedInput ? (parseInt(invertedInput.value) === 1) : false;

            const ds = getEl('dataStore').dataset;
            ds.fed = fed; ds.sahm = sahmDiff; ds.yield = spread; ds.cpi = cpi; ds.buffett = buffett; ds.fear = fear;

            // 1. UIæ›´æ–°
            updateCard('fed', fed, v => v>5 ? ['warn','ç´§ç¼©'] : (v<2?['safe','å®½æ¾']:['neutral','ä¸­æ€§']), true);
            
            if (!isNaN(sahmDiff)) {
                const elDiff = getEl('val_sahm_diff');
                const elRaw = getEl('val_sahm_raw');
                const elBadge = getEl('badge_sahm');
                
                if (elDiff) {
                    elDiff.innerText = `+${sahmDiff.toFixed(2)}%`;
                    if (sahmDiff >= 0.5) elDiff.style.color="var(--red)";
                    else if (sahmDiff >= 0.4) elDiff.style.color="var(--orange)";
                    else elDiff.style.color="var(--green)";
                }
                
                if (elRaw) elRaw.innerText = `(ç°: ${sCur.toFixed(1)}%)`;
                
                if (elBadge) {
                    if (sahmDiff >= 0.5) { 
                        elBadge.className="m-badge bd-danger"; elBadge.innerText="è¡°é€€ç¡®è®¤"; 
                    } else if (sahmDiff >= 0.4) { 
                        elBadge.className="m-badge bd-warn"; elBadge.innerText="é«˜å±"; 
                    } else { 
                        elBadge.className="m-badge bd-safe"; elBadge.innerText="å®‰å…¨"; 
                    }
                }
            } else { resetCard('sahm'); }

            if (!isNaN(spread)) {
                const elY = getEl('val_yield');
                const elBadge = getEl('badge_yield');
                const elDesc = getEl('desc_yield');
                
                if (elY) {
                    elY.innerText = `${spread.toFixed(2)}%`;
                    if (spread < 0) elY.style.color="var(--orange)";
                    else if (spread >= 0 && spread < 0.3 && wasInverted) elY.style.color="var(--red)";
                    else elY.style.color="var(--green)";
                }
                
                if (elBadge) {
                    if (spread < 0) { elBadge.className="m-badge bd-warn"; elBadge.innerText="å€’æŒ‚"; }
                    else if (spread >= 0 && spread < 0.3 && wasInverted) { elBadge.className="m-badge bd-danger"; elBadge.innerText="è¡°é€€å›æ­£"; }
                    else { elBadge.className="m-badge bd-safe"; elBadge.innerText="æ­£å¸¸"; }
                }
                
                if (elDesc) {
                    if (spread < 0) elDesc.innerHTML = "è´Ÿå€¼=å€’æŒ‚ã€‚å½“å‰<strong>å€’æŒ‚ä¸­</strong>ï¼Œå±æœºæ½œä¼ã€‚";
                    else if (spread >= 0 && spread < 0.3 && wasInverted) elDesc.innerHTML = "<strong style='color:#ef4444'>å±é™©ï¼</strong>å€’æŒ‚ç»“æŸï¼Œè¡°é€€å·²è‡³ã€‚";
                    else elDesc.innerText = "æ›²çº¿æ­£å¸¸é™¡å³­åŒ–ï¼Œæ— å€’æŒ‚é£é™©ã€‚";
                }
            } else { resetCard('yield'); }

            updateCard('cpi', cpi, v => v>4 ? ['danger','æ¶æ€§'] : (v>3?['warn','ç²˜æ€§']:['safe','æ¸©å’Œ']), true);
            updateCard('buffett', buffett, v => v>180 ? ['danger','æ³¡æ²«'] : ['safe','åˆç†'], true);
            updateCard('fear', fear, v => v>75 ? ['danger','æè´ª'] : (v<25?['safe','ææ']:['neutral','ä¸­æ€§']), false);

            // 2. æ€»è¯„
            const dispScore = getEl('disp_score');
            if (isNaN(sahmDiff) || isNaN(spread)) { 
                if (dispScore) dispScore.innerText="--"; 
                return; 
            }
            
            if (sourceType === 'live') saveToCache();

            let score = 0, advice = "", alloc = {s:0,b:0,c:0,g:0};
            
            if (sahmDiff >= 0.5 || (spread >= 0 && spread < 0.3 && wasInverted)) {
                score = 90; advice = "ğŸš¨ è¡°é€€ç¡®è®¤ï¼šæ¸…ç©ºè‚¡ç¥¨ï¼Œä¹°å…¥å›½å€º/ç°é‡‘ã€‚"; alloc = {s:0, b:1, c:1, g:0};
            } else if (cpi > 4.0) {
                score = 80; advice = "ğŸ”¥ æ»èƒ€é£é™©ï¼šFed éš¾é™æ¯ã€‚ä¹°é»„é‡‘æŠ—é€šèƒ€ã€‚"; alloc = {s:0, b:0, c:1, g:1};
            } else if (buffett > 200 && fear > 75) {
                score = 70; advice = "ğŸˆ æ³¡æ²«å¤ªè´µï¼šæŒæœ‰ç°é‡‘ï¼Œç­‰å¾…æš´è·Œã€‚"; alloc = {s:0, b:0, c:1, g:0};
            } else if (sahmDiff < 0.4 && fear < 25) {
                score = 20; advice = "ğŸ’° é»„é‡‘å‘ï¼šå®è§‚å®‰å…¨ï¼Œå¤§èƒ†æŠ„åº•è‚¡ç¥¨ã€‚"; alloc = {s:1, b:0, c:0, g:0};
            } else {
                score = 40; advice = "âš–ï¸ å®è§‚æ¸©å’Œï¼šæŒæœ‰æ ¸å¿ƒè‚¡ç¥¨èµ„äº§ã€‚"; alloc = {s:1, b:0, c:0, g:1};
            }

            if (dispScore) {
                dispScore.innerText = score;
                dispScore.className = `score-val ${score>60?(score>80?'st-danger':'st-warn'):'st-safe'}`;
            }
            
            const adviceText = getEl('adviceText');
            if (adviceText) adviceText.innerText = advice;
            
            const mainCard = getEl('mainCard');
            if (mainCard) mainCard.style.borderColor = score>60?(score>80?'var(--red)':'var(--orange)'):'var(--green)';

            setStrat('st_stock', alloc.s); setStrat('st_bond', alloc.b); setStrat('st_cash', alloc.c); setStrat('st_gold', alloc.g);
        }

        // --- è¾…åŠ© ---
        function updateCard(id, val, logic, isPct) {
            if(isNaN(val)) { resetCard(id); return; }
            const elVal = getEl(`val_${id}`);
            const elBadge = getEl(`badge_${id}`);
            if (elVal) elVal.innerText = val + (isPct?"%":"");
            
            if (elBadge) {
                const [cls, txt] = logic(val);
                elBadge.className = `m-badge bd-${cls}`;
                elBadge.innerText = txt;
            }
        }
        
        function resetCard(id) {
            const elDiff = getEl('val_sahm_diff');
            const elRaw = getEl('val_sahm_raw');
            const elVal = getEl(`val_${id}`);
            const elBadge = getEl(`badge_${id}`);

            if (id === 'sahm') {
                if (elDiff) { elDiff.innerText = "--"; elDiff.style.color = ""; }
                if (elRaw) elRaw.innerText = "";
            } else {
                if (elVal) elVal.innerText = "--";
            }
            
            if (elBadge) {
                elBadge.innerText = "Waiting";
                elBadge.className = "m-badge neutral";
            }
        }
        function setStrat(id, on) {
            const el = getEl(id);
            if (!el) return;
            el.className = "strat-tag";
            if(on) {
                if(id.includes('gold')) el.classList.add('strat-gold');
                else if(id.includes('cash')) el.classList.add('strat-cash');
                else el.classList.add('strat-active');
            }
        }

        // --- ç¼“å­˜ä¸å¿«ç…§ ---
        function saveToCache() {
            const data = {
                timestamp: Date.now(),
                inputs: {
                    fed: getEl('inp_fed').value,
                    sahm_cur: getEl('inp_sahm_cur').value,
                    sahm_low: getEl('inp_sahm_low').value,
                    yield: getEl('inp_yield').value,
                    inverted: getEl('inp_was_inverted').value,
                    cpi: getEl('inp_cpi').value,
                    buffett: getEl('inp_buffett').value,
                    fear: getEl('inp_fear').value
                }
            };
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        }

        function loadFromCache() {
            const raw = localStorage.getItem(CACHE_KEY);
            if (!raw) return false;
            try {
                const data = JSON.parse(raw);
                if (Date.now() - data.timestamp > 86400000) return false; // 24h
                fillInputs(data.inputs);
                calc('cache');
                return true;
            } catch(e) { return false; }
        }

        function loadSnapshot() {
            fillInputs(SNAPSHOT);
            calc('snapshot');
        }

        function fillInputs(data) {
            if (getEl('inp_fed')) getEl('inp_fed').value = data.fed;
            if (getEl('inp_sahm_cur')) getEl('inp_sahm_cur').value = data.sahm_cur;
            if (getEl('inp_sahm_low')) getEl('inp_sahm_low').value = data.sahm_low;
            if (getEl('inp_yield')) getEl('inp_yield').value = data.yield;
            if (getEl('inp_was_inverted')) getEl('inp_was_inverted').value = data.inverted;
            if (getEl('inp_cpi')) getEl('inp_cpi').value = data.cpi;
            if (getEl('inp_buffett')) getEl('inp_buffett').value = data.buffett;
            if (getEl('inp_fear')) getEl('inp_fear').value = data.fear;
        }

        // --- API æŠ“å– ---
        async function fetchData(force = false) {
            if (!force && loadFromCache()) return;

            const btn = getEl('btnRefresh');
            const keyEl = getEl('apiKey');
            const status = getEl('statusText');
            
            if(!keyEl) return;
            const key = keyEl.value;

            if (btn) btn.classList.add('refresh-btn', 'spinning');
            if (status) {
                status.innerText = "è¿æ¥ä¸­(éœ€çº¦10ç§’)...";
                status.style.color = "var(--primary)";
            }
            
            const setCardLoading = (id, loading) => {
                const card = document.getElementById(`metric-card-${id}`) || document.getElementById(`card_${id}`);
                if(card) loading ? card.classList.add('loading') : card.classList.remove('loading');
            };

            const safeFetch = async (url) => { try { const r=await fetch(url).then(j=>j.json()); return (r.Note||r.Information)?{err:'limit'}:r; } catch { return {err:'net'}; } };

            try {
                // 1. Fed
                setCardLoading('fed', true);
                const fRes = await safeFetch(`https://www.alphavantage.co/query?function=FEDERAL_FUNDS_RATE&interval=monthly&apikey=${key}`);
                if(fRes&&fRes.data) getEl('inp_fed').value = parseFloat(fRes.data[0].value);
                else if(fRes.err==='limit') { 
                    alert("APIé™æµ (æ¯åˆ†é’Ÿ5æ¬¡)ã€‚å·²ä¸ºæ‚¨ä¿ç•™å½“å‰æ˜¾ç¤ºçš„æ•°æ®ï¼Œè¯·ç¨åå†è¯•ã€‚");
                    throw 'Limit';
                }
                setCardLoading('fed', false);
                await new Promise(r=>setTimeout(r,1200));

                // 2. Sahm
                setCardLoading('sahm', true);
                const u = await safeFetch(`https://www.alphavantage.co/query?function=UNEMPLOYMENT&apikey=${key}`);
                if(u&&u.data) {
                    const d=u.data; const cur=(parseFloat(d[0].value)+parseFloat(d[1].value)+parseFloat(d[2].value))/3;
                    let min=100; for(let i=0;i<12;i++) { const m=(parseFloat(d[i].value)+parseFloat(d[i+1].value)+parseFloat(d[i+2].value))/3; if(m<min)min=m; }
                    getEl('inp_sahm_cur').value = cur.toFixed(2);
                    getEl('inp_sahm_low').value = min.toFixed(2);
                }
                setCardLoading('sahm', false);
                await new Promise(r=>setTimeout(r,1200));
                
                // 3. Yield
                setCardLoading('yield', true);
                const t10 = await safeFetch(`https://www.alphavantage.co/query?function=TREASURY_YIELD&interval=monthly&maturity=10year&apikey=${key}`);
                await new Promise(r=>setTimeout(r,1200));
                const t2 = await safeFetch(`https://www.alphavantage.co/query?function=TREASURY_YIELD&interval=monthly&maturity=2year&apikey=${key}`);
                if(t10&&t10.data&&t2&&t2.data) {
                    getEl('inp_yield').value = (parseFloat(t10.data[0].value)-parseFloat(t2.data[0].value)).toFixed(2);
                    let hasInverted = 0;
                    for (let i=0; i<Math.min(18, t10.data.length); i++) {
                        if ((parseFloat(t10.data[i].value)-parseFloat(t2.data[i].value)) < 0) { hasInverted=1; break; }
                    }
                    getEl('inp_was_inverted').value = hasInverted;
                }
                setCardLoading('yield', false);
                await new Promise(r=>setTimeout(r,1200));

                // 4. CPI
                setCardLoading('cpi', true);
                const c = await safeFetch(`https://www.alphavantage.co/query?function=CPI&interval=monthly&apikey=${key}`);
                if(c&&c.data) {
                    const now=parseFloat(c.data[0].value); const last=parseFloat(c.data[12].value);
                    getEl('inp_cpi').value = (((now-last)/last)*100).toFixed(1);
                }
                setCardLoading('cpi', false);

                if (status) {
                    status.innerText = "æ›´æ–°æˆåŠŸ (å·²ç¼“å­˜)";
                    status.style.color = "var(--green)";
                }
                calc('live');
            } catch(e) {
                if(e !== 'Limit' && status) {
                    status.innerText = "ç½‘ç»œé”™è¯¯ï¼Œä¿ç•™ç°æœ‰æ•°æ®";
                    status.style.color = "var(--orange)";
                }
            } finally { 
                if (btn) btn.classList.remove('spinning'); 
                ['fed','sahm','yield','cpi'].forEach(id => setCardLoading(id, false));
            }
        }
        
        // --- äº¤äº’ ---
        let currEdit = '';
        function openEdit(f) {
            currEdit = f;
            let title = "";
            let useModal = true;
            
            const sahmInputs = getEl('sahmInputs');
            const modalInput = getEl('modalInput');

            if(f==='sahm') {
                title="å¤±ä¸šç‡é…ç½®";
                if(modalInput) modalInput.style.display = 'none';
                if(sahmInputs) {
                    sahmInputs.style.display = 'flex';
                    const curVal = getEl('inp_sahm_cur') ? getEl('inp_sahm_cur').value : "";
                    const lowVal = getEl('inp_sahm_low') ? getEl('inp_sahm_low').value : "";
                    if(getEl('modalSahmCur')) getEl('modalSahmCur').value = curVal;
                    if(getEl('modalSahmLow')) getEl('modalSahmLow').value = lowVal;
                }
            } else {
                if(modalInput) modalInput.style.display = 'block';
                if(sahmInputs) sahmInputs.style.display = 'none';
                
                if(f==='fed') title="è”é‚¦åŸºé‡‘åˆ©ç‡ (%)";
                if(f==='yield') title="ç¾å€ºåˆ©å·® (10-2) (%)";
                if(f==='cpi') title="CPI é€šèƒ€ (%)";
                if(f==='buffett') title="å·´è²ç‰¹æŒ‡æ ‡ (%)";
                if(f==='fear') title="ææ…ŒæŒ‡æ•° (0-100)";
                
                let iid = `inp_${f}`;
                const val = getEl(iid) ? getEl(iid).value : "";
                if(modalInput) modalInput.value = val;
            }

            const modalTitle = getEl('modalTitle');
            if(modalTitle) modalTitle.innerText = title;
            
            const editModal = getEl('editModal');
            if(editModal) editModal.style.display = 'flex';
            
            if(f!=='sahm' && modalInput) modalInput.focus();
        }

        function closeEdit() { 
            const editModal = getEl('editModal');
            if(editModal) editModal.style.display = 'none'; 
        }
        
        function saveEdit() {
            if(currEdit==='sahm') {
                if(getEl('inp_sahm_cur') && getEl('modalSahmCur')) getEl('inp_sahm_cur').value = getEl('modalSahmCur').value;
                if(getEl('inp_sahm_low') && getEl('modalSahmLow')) getEl('inp_sahm_low').value = getEl('modalSahmLow').value;
            } else {
                if(getEl(`inp_${currEdit}`) && getEl('modalInput')) getEl(`inp_${currEdit}`).value = getEl('modalInput').value;
            }
            calc('manual'); // æ ‡è®°ä¸ºæ‰‹åŠ¨
            closeEdit();
        }

        function toggleSettings() { 
            const panel = getEl('settingsPanel');
            const overlay = getEl('overlay');
            if(panel) panel.classList.toggle('open'); 
            if(overlay) overlay.classList.toggle('open'); 
        }
        
        function clearData() { 
            ['inp_fed','inp_sahm_cur','inp_sahm_low','inp_yield','inp_cpi','inp_buffett','inp_fear'].forEach(i => {
                if(getEl(i)) getEl(i).value='';
            }); 
            calc(); 
            if(getEl('statusText')) getEl('statusText').innerText="å·²æ¸…ç©º"; 
        }
        
        function mockDanger() { 
            if(getEl('inp_fed')) getEl('inp_fed').value=2.0; 
            if(getEl('inp_sahm_cur')) getEl('inp_sahm_cur').value=4.3; 
            if(getEl('inp_sahm_low')) getEl('inp_sahm_low').value=3.7; 
            if(getEl('inp_yield')) getEl('inp_yield').value=0.1; 
            if(getEl('inp_was_inverted')) getEl('inp_was_inverted').value=1; 
            if(getEl('inp_cpi')) getEl('inp_cpi').value=2.2; 
            if(getEl('inp_fear')) getEl('inp_fear').value=10; 
            calc('manual'); 
            toggleSettings(); 
        }

        // ğŸš€ å¯åŠ¨ï¼šå…ˆå°è¯•ç¼“å­˜ï¼Œæ²¡æœ‰åˆ™åŠ è½½å¿«ç…§ï¼Œæœ€åå°è¯•æŠ“å– (é™é»˜)
        window.onload = function() {
            if(!loadFromCache()) {
                loadSnapshot();
                // å»¶è¿Ÿ 1ç§’ è‡ªåŠ¨æŠ“å–æœ€æ–°ï¼Œå¦‚æœæˆåŠŸåˆ™è¦†ç›–å¿«ç…§
                setTimeout(fetchData, 1000);
            }
        };
    </script>
</body>
</html>
