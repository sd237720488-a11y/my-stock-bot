<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaSystem å®è§‚å…¨æ™¯æŒ‡æŒ¥å° V4.7 (å…¨èƒ½å½•å…¥ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        :root { --bg-dark: #0f172a; --card-bg: #1e293b; --text-main: #e2e8f0; --text-muted: #94a3b8; --border: #334155; --primary: #3b82f6; --primary-hover: #2563eb; --success: #10b981; --warn: #f59e0b; --danger: #ef4444; }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1280px; margin: 0 auto; }
        .grid-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .grid-dashboard { display: grid; grid-template-columns: 1fr 3fr; gap: 20px; margin-bottom: 30px; }
        .grid-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .grid-sub-metrics { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        @media (max-width: 768px) { .grid-header { flex-direction: column; align-items: flex-start; gap: 16px; } .grid-dashboard { grid-template-columns: 1fr; } .grid-sub-metrics { grid-template-columns: 1fr 1fr; } .grid-panels { grid-template-columns: 1fr; } }
        .card { background-color: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card.risk-panel { border-left: 5px solid var(--primary); background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .card.top-border-red { border-top: 4px solid var(--danger); }
        .card.top-border-indigo { border-top: 4px solid #6366f1; }
        .card.top-border-purple { border-top: 4px solid #a855f7; }
        .card.top-border-emerald { border-top: 4px solid var(--success); }
        h1 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        h2 { margin: 0 0 16px 0; font-size: 1rem; color: #fff; display: flex; align-items: center; gap: 8px; }
        .tag-version { font-size: 12px; background: #312e81; color: #a5b4fc; padding: 2px 8px; border-radius: 4px; border: 1px solid #4338ca; }
        .text-desc { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
        .label { font-size: 11px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .big-number { font-size: 2.5rem; font-weight: 900; color: #fff; line-height: 1; }
        .mono-number { font-family: 'Roboto Mono', monospace; font-weight: 700; }
        .control-group { display: flex; gap: 8px; align-items: center; background: #334155; padding: 4px; border-radius: 6px; }
        input[type="text"], input[type="number"] { background: var(--bg-dark); border: 1px solid var(--border); color: #fff; padding: 6px 10px; border-radius: 4px; font-family: monospace; outline: none; }
        input[type="text"] { width: 200px; text-align: center; }
        input[type="number"] { width: 100%; text-align: right; font-size: 16px; }
        
        /* èšç„¦æ—¶çš„æ ·å¼ï¼šè®©ç”¨æˆ·çŸ¥é“è¿™å¯ä»¥å¡« */
        input[type="number"]:focus { border-color: var(--primary); background: #1e293b; }
        input[type="number"]:not([readonly]):hover { border-color: #64748b; cursor: text; }

        button { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        button:hover { background: var(--primary-hover); }
        button:disabled { background: var(--border); cursor: wait; color: var(--text-muted); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; }
        .badge.neutral { background: #334155; color: #cbd5e1; }
        .badge.safe { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid #059669; }
        .badge.warn { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid #b45309; }
        .badge.danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #b91c1c; }
        .progress-track { background: #334155; height: 8px; border-radius: 4px; position: relative; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; transition: width 0.8s ease; }
        .marker { position: absolute; top: 0; bottom: 0; width: 2px; background: #fff; opacity: 0.5; }
        .mini-card { background: rgba(30, 41, 59, 0.7); border: 1px solid var(--border); padding: 12px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; }
        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .toolbar { display: flex; gap: 10px; margin-top: 10px; font-size: 12px; }
        .btn-text { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 4px 10px; }
        .btn-text:hover { color: #fff; border-color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <header class="grid-header">
        <div>
            <h1>
                ğŸ›¸ AlphaSystem å®è§‚å…¨æ™¯æŒ‡æŒ¥å°
                <span class="tag-version">V4.7 å…¨èƒ½å½•å…¥ç‰ˆ</span>
            </h1>
            <div class="text-desc">
                âš¡ï¸ <strong>æ¨¡å¼ï¼š</strong>è‡ªåŠ¨æŠ“å–ä¼˜å…ˆ | æ”¯æŒå…¨æ•°æ®æ‰‹åŠ¨ä¿®æ­£
            </div>
        </div>
        <div>
            <div class="control-group">
                <span class="label" style="color: #fff; margin: 0 8px;">API KEY</span>
                <input type="text" id="apiKey" value="O0VQP18WF8I5N66X" placeholder="AlphaVantage Key">
                <button onclick="fetchOfficialData()" id="fetchBtn">
                    <span id="btnIcon">ğŸ“¡</span> åˆ·æ–°æ•°æ®
                </button>
            </div>
            <div class="toolbar" style="justify-content: flex-end;">
                <button class="btn-text" onclick="loadDemoData()">ğŸ“ å¡«å…¥å±æœºæ¨¡æ‹Ÿæ•°æ®</button>
                <button class="btn-text" onclick="clearData()">ğŸ§¹ æ¸…ç©º</button>
            </div>
            <div class="text-desc" style="text-align: right; margin-top: 5px;" id="lastUpdate">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </header>

    <!-- ç»¼åˆé£é™©é¢æ¿ -->
    <div class="grid-dashboard">
        <!-- å·¦ä¾§æ€»è¯„ -->
        <div class="card risk-panel">
            <div class="label">ç»¼åˆé£é™©è¯„åˆ† (Risk Score)</div>
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                <div style="display: flex; align-items: baseline; gap: 8px;">
                    <div class="big-number" id="globalScore">--</div>
                    <span style="color: var(--text-muted);">/ 100</span>
                </div>
                <div id="positionAdvice" style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 14px; line-height: 1.5;">
                    è¯·ç‚¹å‡»åˆ·æ–°ï¼Œæˆ–æ‰‹åŠ¨å¡«å…¥æ•°æ®...
                </div>
            </div>
        </div>

        <!-- å³ä¾§æŒ‡æ ‡æ¦‚è§ˆ -->
        <div class="grid-sub-metrics">
            <div class="mini-card">
                <div class="label">å¤±ä¸šç‡ (Sahm)</div>
                <div class="mono-number" style="font-size: 1.2rem;" id="val_sahm">--</div>
                <div id="badge_sahm" class="badge neutral">Waiting</div>
            </div>
            <div class="mini-card">
                <div class="label">ç¾å€ºåˆ©å·®</div>
                <div class="mono-number" style="font-size: 1.2rem;" id="val_yield">--</div>
                <div id="badge_yield" class="badge neutral">Waiting</div>
            </div>
            <div class="mini-card" style="border-color: #6366f1;">
                <div class="label" style="color: #818cf8;">CPI é€šèƒ€</div>
                <div class="mono-number" style="font-size: 1.2rem;" id="val_cpi">--</div>
                <div id="badge_cpi" class="badge neutral">Waiting</div>
            </div>
            <div class="mini-card">
                <div class="label">å·´è²ç‰¹æŒ‡æ ‡</div>
                <div class="mono-number" style="font-size: 1.2rem;" id="val_buffett">--%</div>
                <div id="badge_buffett" class="badge neutral">æ‰‹åŠ¨</div>
            </div>
            <div class="mini-card">
                <div class="label">ææ…ŒæŒ‡æ•°</div>
                <div class="mono-number" style="font-size: 1.2rem;" id="val_fear">--</div>
                <div id="badge_fear" class="badge neutral">æ‰‹åŠ¨</div>
            </div>
        </div>
    </div>

    <!-- è¯¦ç»†æ•°æ®é¢æ¿ -->
    <div class="grid-panels">
        
        <!-- 1. è¨å§†è§„åˆ™ -->
        <div class="card top-border-red">
            <div style="display:flex; justify-content:space-between;">
                <h2>ğŸ›‘ è¨å§†è§„åˆ™ (å¤±ä¸šç‡)</h2>
                <span style="font-size:10px; color:#94a3b8">æ”¯æŒæ‰‹åŠ¨</span>
            </div>
            <div style="height: 150px; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 16px;">
                <canvas id="sahmChart"></canvas>
            </div>
            <div class="data-row">
                <div style="flex: 1; padding-right: 10px;">
                    <div class="label">å½“å‰3ä¸ªæœˆå‡å€¼ (%)</div>
                    <!-- è§£é”è¾“å…¥æ¡† -->
                    <input type="number" id="inp_sahm_cur" placeholder="ä¾‹å¦‚ 4.1" step="0.1" oninput="calculateRisk()">
                </div>
                <div style="flex: 1; padding-left: 10px; border-left: 1px solid var(--border);">
                    <div class="label">è¿‡å»12æœˆæœ€ä½ (%)</div>
                    <!-- è§£é”è¾“å…¥æ¡† -->
                    <input type="number" id="inp_sahm_low" placeholder="ä¾‹å¦‚ 3.7" step="0.1" oninput="calculateRisk()">
                </div>
            </div>
            <div class="text-desc" style="display: flex; justify-content: space-between;">
                <span>åå¼¹å¹…åº¦: <strong id="val_sahm_diff" style="color: #fff">--</strong></span>
                <span>ç†”æ–­é˜ˆå€¼: <strong style="color: var(--danger)">+0.50%</strong></span>
            </div>
        </div>

        <!-- 2. æ”¶ç›Šç‡æ›²çº¿ -->
        <div class="card top-border-indigo">
            <div style="display:flex; justify-content:space-between;">
                <h2>ğŸ¦ æ”¶ç›Šç‡æ›²çº¿ (10å¹´ - 2å¹´)</h2>
                <span style="font-size:10px; color:#94a3b8">æ”¯æŒæ‰‹åŠ¨</span>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 0 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                    <span style="color: var(--danger)">å€’æŒ‚ (å±æœº)</span>
                    <span style="color: var(--success)">é™¡å³­ (å¤è‹)</span>
                </div>
                <div class="progress-track">
                    <div class="marker" style="left: 30%;"></div>
                    <div id="bar_yield" class="progress-fill" style="background: var(--text-muted); width: 0%; margin-left: 30%;"></div>
                </div>
                <div style="text-align: center; margin-top: 10px; font-family: monospace; font-size: 1.5rem; font-weight: bold;" id="val_yield_spread">
                    --
                </div>
                
                <!-- æ˜¾å½¢ï¼šè®©ç”¨æˆ·å¯ä»¥è¾“å…¥ -->
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <div style="flex:1">
                        <div class="label" style="text-align:center">10å¹´æœŸ (%)</div>
                        <input type="number" id="inp_y10" placeholder="4.45" step="0.01" oninput="calculateRisk()" style="text-align:center">
                    </div>
                    <div style="flex:1">
                        <div class="label" style="text-align:center">2å¹´æœŸ (%)</div>
                        <input type="number" id="inp_y2" placeholder="4.25" step="0.01" oninput="calculateRisk()" style="text-align:center">
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. å¸‚åœºä¼°å€¼ -->
        <div class="card top-border-purple">
            <div style="display: flex; justify-content: space-between;">
                <h2>ğŸ” ä¼°å€¼ (å·´è²ç‰¹æŒ‡æ ‡)</h2>
                <a href="https://www.currentmarketvaluation.com/" target="_blank" style="font-size: 12px; color: var(--primary);">æ¥æº â†—</a>
            </div>
            <div style="margin-bottom: 20px;">
                <div class="label">æ€»å¸‚å€¼ / GDP (æ‰‹åŠ¨)</div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="number" id="inp_buffett" value="221.7" oninput="calculateRisk()" style="font-size: 1.2rem; font-weight: bold; color: #a855f7;">
                    <span>%</span>
                </div>
            </div>
            <div class="progress-track" style="height: 6px;">
                <div class="marker" style="left: 25%; background: var(--success);"></div>
                <div class="marker" style="left: 50%; background: var(--warn);"></div>
                <div id="pointer_buffett" style="position: absolute; width: 4px; height: 16px; background: #fff; top: -5px; left: 0%; transition: left 0.5s;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-top: 5px;">
                <span>ä½ä¼°</span><span>åˆç†(100%)</span><span>æ³¡æ²«(200%)</span>
            </div>
        </div>

        <!-- 4. å¸‚åœºæƒ…ç»ª -->
        <div class="card top-border-emerald">
            <div style="display: flex; justify-content: space-between;">
                <h2>ğŸ˜¨ æƒ…ç»ª (ææ…Œè´ªå©ª)</h2>
                <a href="https://edition.cnn.com/markets/fear-and-greed" target="_blank" style="font-size: 12px; color: var(--primary);">CNN â†—</a>
            </div>
            <div style="text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center;">
                <div class="big-number" id="disp_fear" style="transition: color 0.3s;">52</div>
                <div id="text_fear" style="font-weight: bold; margin-bottom: 10px;">Neutral</div>
                <input type="range" id="rng_fear" min="0" max="100" value="52" style="width: 100%; cursor: pointer;" oninput="syncFearInput(this.value)">
                <input type="hidden" id="inp_fear" value="52">
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 10px; margin-top: 10px;">
                <span style="color: var(--success)">0 ææ(ä¹°)</span>
                <span style="color: var(--danger)">100 æè´ª(å–)</span>
            </div>
            
            <!-- CPI æ˜¾ç¤ºåŒº -->
            <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <span class="label">CPI é€šèƒ€</span>
                <!-- è§£é”è¾“å…¥æ¡† -->
                <input type="number" id="inp_cpi" placeholder="--" step="0.1" oninput="calculateRisk()" style="width: 80px; text-align: center; font-weight: bold;">
            </div>
        </div>

    </div>
</div>

<script>
    const getEl = (id) => document.getElementById(id);
    
    function syncFearInput(val) {
        getEl('inp_fear').value = val;
        calculateRisk();
    }

    // --- æ¨¡æ‹Ÿæ¼”ç¤ºæ•°æ® (åº”æ€¥ç”¨) ---
    function loadDemoData() {
        getEl('inp_sahm_cur').value = "4.4"; // å±é™©å€¼
        getEl('inp_sahm_low').value = "3.7";
        getEl('inp_y10').value = "3.8";
        getEl('inp_y2').value = "4.2"; // å€’æŒ‚
        getEl('inp_cpi').value = "3.2";
        getEl('inp_fear').value = "80"; // è´ªå©ª
        getEl('rng_fear').value = "80";
        calculateRisk();
        alert("âš ï¸ å·²å¡«å…¥ã€å±æœºå‰å¤•ã€‘æ¨¡æ‹Ÿæ•°æ®");
    }

    function clearData() {
        ['inp_sahm_cur', 'inp_sahm_low', 'inp_y10', 'inp_y2', 'inp_cpi'].forEach(id => getEl(id).value = '');
        calculateRisk();
    }

    // --- 1. ä¸¥æ ¼çš„æ•°æ®è·å– ---
    async function fetchOfficialData() {
        const apiKey = getEl('apiKey').value.trim();
        const btn = getEl('fetchBtn');
        const icon = getEl('btnIcon');
        const statusDiv = getEl('lastUpdate');

        if(!apiKey) { alert("è¯·å¡«å†™ API å¯†é’¥"); return; }

        btn.disabled = true;
        icon.innerText = "â³";
        statusDiv.innerText = "æ­£åœ¨è¯·æ±‚ API...";
        statusDiv.style.color = "var(--warn)";

        const safeFetch = async (url) => {
            try {
                const res = await fetch(url).then(r => r.json());
                if (res.Note || res.Information) return { error: "Limit" };
                if (!res.data) return { error: "NoData" };
                return res;
            } catch(e) { return { error: "NetErr" }; }
        };

        try {
            // ä¸²è¡Œè¯·æ±‚é˜²æ­¢ 429
            const resUnemp = await safeFetch(`https://www.alphavantage.co/query?function=UNEMPLOYMENT&apikey=${apiKey}`);
            if (resUnemp.data) processSahm(resUnemp.data);
            
            await new Promise(r => setTimeout(r, 1500)); 

            const res10y = await safeFetch(`https://www.alphavantage.co/query?function=TREASURY_YIELD&interval=monthly&maturity=10year&apikey=${apiKey}`);
            await new Promise(r => setTimeout(r, 1500));
            const res2y = await safeFetch(`https://www.alphavantage.co/query?function=TREASURY_YIELD&interval=monthly&maturity=2year&apikey=${apiKey}`);
            
            if (res10y.data && res2y.data) processYield(res10y.data, res2y.data);

            await new Promise(r => setTimeout(r, 1500));

            const resCpi = await safeFetch(`https://www.alphavantage.co/query?function=CPI&interval=monthly&apikey=${apiKey}`);
            if (resCpi.data) processCpi(resCpi.data);

            const now = new Date();
            statusDiv.innerText = `åŒæ­¥å®Œæˆ: ${now.toLocaleTimeString()}`;
            statusDiv.style.color = "var(--success)";
            
            calculateRisk(); 

        } catch(e) {
            console.error(e);
            statusDiv.innerText = "ç½‘ç»œé”™è¯¯";
            statusDiv.style.color = "var(--danger)";
        } finally {
            btn.disabled = false;
            icon.innerText = "ğŸ“¡";
        }
    }

    // --- æ•°æ®å¤„ç† ---
    function processSahm(data) {
        if(data.length < 24) return;
        const curMA = (parseFloat(data[0].value) + parseFloat(data[1].value) + parseFloat(data[2].value)) / 3;
        let minMA = 100;
        for(let i=0; i<12; i++) {
            const ma = (parseFloat(data[i].value) + parseFloat(data[i+1].value) + parseFloat(data[i+2].value)) / 3;
            if(ma < minMA) minMA = ma;
        }
        getEl('inp_sahm_cur').value = curMA.toFixed(2);
        getEl('inp_sahm_low').value = minMA.toFixed(2);
    }

    function processYield(d10, d2) {
        getEl('inp_y10').value = parseFloat(d10[0].value);
        getEl('inp_y2').value = parseFloat(d2[0].value);
    }

    function processCpi(data) {
        if(data.length < 13) return;
        const cur = parseFloat(data[0].value);
        const prevYear = parseFloat(data[12].value);
        const yoy = ((cur - prevYear) / prevYear) * 100;
        getEl('inp_cpi').value = yoy.toFixed(2);
    }

    // --- æ ¸å¿ƒå›¾è¡¨ ---
    let sahmChartInstance = null;
    function initChart() {
        const ctx = document.getElementById('sahmChart').getContext('2d');
        if (typeof Chart === 'undefined') return;
        sahmChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['ç†”æ–­çº¿', 'å½“å‰å·®'],
                datasets: [{
                    data: [0.5, 0],
                    backgroundColor: ['rgba(239, 68, 68, 0.2)', 'rgba(52, 211, 153, 0.5)'],
                    borderColor: ['rgba(239, 68, 68, 1)', 'rgba(52, 211, 153, 1)'],
                    borderWidth: 1,
                    barPercentage: 0.6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, max: 1.0, grid: { color: '#334155' } },
                    y: { grid: { display: false }, ticks: { color: '#cbd5e1' } }
                }
            }
        });
    }

    // --- é£æ§æ¨¡å‹ ---
    function calculateRisk() {
        const sahmCur = parseFloat(getEl('inp_sahm_cur').value);
        const sahmLow = parseFloat(getEl('inp_sahm_low').value);
        
        let sahmDiff = 0;
        let hasSahm = false;
        
        if (!isNaN(sahmCur) && !isNaN(sahmLow)) {
            sahmDiff = sahmCur - sahmLow;
            hasSahm = true;
        }

        const y10 = parseFloat(getEl('inp_y10').value);
        const y2 = parseFloat(getEl('inp_y2').value);
        const ySpread = (!isNaN(y10) && !isNaN(y2)) ? (y10 - y2) : null;

        const cpi = parseFloat(getEl('inp_cpi').value);
        const buffett = parseFloat(getEl('inp_buffett').value); 
        const fear = parseFloat(getEl('inp_fear').value); 

        // 1. Sahm UI
        const elDiff = getEl('val_sahm_diff');
        const badgeSahm = getEl('badge_sahm');
        
        if (hasSahm) {
            elDiff.innerText = (sahmDiff > 0 ? "+" : "") + sahmDiff.toFixed(2) + "%";
            elDiff.style.color = sahmDiff >= 0.4 ? "var(--warn)" : (sahmDiff >= 0.5 ? "var(--danger)" : "var(--success)");
            getEl('val_sahm').innerText = sahmCur.toFixed(2) + "%";
            
            if(sahmDiff >= 0.5) { badgeSahm.className="badge danger"; badgeSahm.innerText="è¡°é€€ç¡®è®¤"; }
            else if(sahmDiff >= 0.4) { badgeSahm.className="badge warn"; badgeSahm.innerText="é«˜å±é¢„è­¦"; }
            else { badgeSahm.className="badge safe"; badgeSahm.innerText="å®‰å…¨"; }
        } else {
            elDiff.innerText = "--";
            getEl('val_sahm').innerText = "--";
            badgeSahm.className="badge neutral"; badgeSahm.innerText="Waiting";
        }
        
        if (sahmChartInstance) {
            sahmChartInstance.data.datasets[0].data[1] = hasSahm ? sahmDiff : 0;
            sahmChartInstance.data.datasets[0].backgroundColor[1] = sahmDiff >= 0.5 ? '#ef4444' : (sahmDiff >= 0.4 ? '#fbbf24' : '#10b981');
            sahmChartInstance.update();
        }

        // 2. Yield UI
        const badgeYield = getEl('badge_yield');
        if (ySpread !== null) {
            getEl('val_yield').innerText = ySpread.toFixed(2) + "%";
            getEl('val_yield_spread').innerText = (ySpread > 0 ? "+" : "") + ySpread.toFixed(2) + "%";
            
            const bar = getEl('bar_yield');
            let pct = ((ySpread + 1.0) / 3.0) * 100;
            pct = Math.max(0, Math.min(100, pct));
            
            bar.style.marginLeft = ySpread >= 0 ? "30%" : `${pct}%`;
            bar.style.width = ySpread >= 0 ? `${pct - 30}%` : `${30 - pct}%`;
            bar.style.background = ySpread < 0 ? "#ef4444" : (ySpread < 0.3 ? "#eab308" : "#10b981");

            if(ySpread < 0) { badgeYield.className="badge danger"; badgeYield.innerText="å€’æŒ‚"; }
            else if(ySpread < 0.3) { badgeYield.className="badge warn"; badgeYield.innerText="æ‰å¹³/å›æ­£"; }
            else { badgeYield.className="badge safe"; badgeYield.innerText="æ­£å¸¸"; }
        } else {
            getEl('val_yield').innerText = "--";
            getEl('val_yield_spread').innerText = "--";
            badgeYield.className="badge neutral"; badgeYield.innerText="Waiting";
        }

        // 3. Fear UI
        if (!isNaN(fear)) {
            getEl('rng_fear').value = fear;
            getEl('val_fear').innerText = fear;
            const dispFear = getEl('disp_fear');
            dispFear.innerText = fear;
            const txt = getEl('text_fear');
            const badge = getEl('badge_fear');
            
            if(fear < 25) { 
                txt.innerText = "æåº¦ææ…Œ (ä¹°)"; txt.style.color = "var(--success)"; dispFear.style.color = "var(--success)";
                badge.className="badge safe"; badge.innerText="é»„é‡‘å‘";
            } else if(fear > 75) { 
                txt.innerText = "æåº¦è´ªå©ª (å–)"; txt.style.color = "var(--danger)"; dispFear.style.color = "var(--danger)";
                badge.className="badge danger"; badge.innerText="é«˜é£é™©";
            } else { 
                txt.innerText = "ä¸­æ€§"; txt.style.color = "var(--text-muted)"; dispFear.style.color = "#fff";
                badge.className="badge neutral"; badge.innerText="è§‚æœ›";
            }
        }
        
        // 4. Buffett UI
        if (!isNaN(buffett)) {
            getEl('val_buffett').innerText = buffett + "%";
            const badge = getEl('badge_buffett');
            if (buffett > 200) { badge.className="badge danger"; badge.innerText="ä¸¥é‡æ³¡æ²«"; }
            else if (buffett > 150) { badge.className="badge warn"; badge.innerText="æ˜¾è‘—é«˜ä¼°"; }
            else { badge.className="badge safe"; badge.innerText="åˆç†"; }
            getEl('pointer_buffett').style.left = `${Math.min(buffett / 2, 100)}%`;
        }
        
        // 5. CPI UI
        const badgeCpi = getEl('badge_cpi');
        if (!isNaN(cpi)) {
            getEl('val_cpi').innerText = cpi + "%";
            if (cpi > 4.0) { badgeCpi.className="badge danger"; badgeCpi.innerText="æ¶æ€§é€šèƒ€"; }
            else if (cpi > 3.0) { badgeCpi.className="badge warn"; badgeCpi.innerText="ç²˜æ€§"; }
            else { badgeCpi.className="badge safe"; badgeCpi.innerText="æ¸©å’Œ"; }
        } else {
            badgeCpi.className="badge neutral"; badgeCpi.innerText="Waiting";
        }

        // --- è¯„åˆ† ---
        if (!hasSahm && ySpread === null) {
            getEl('globalScore').innerText = "--";
            getEl('positionAdvice').innerText = "ç­‰å¾…æ•°æ®åŒæ­¥...";
            return;
        }

        let riskLevel = "SAFE"; 
        let vetoReason = "";
        
        let scoreSahm = 0; 
        if(hasSahm) {
            if(sahmDiff >= 0.5) scoreSahm = 100;
            else if(sahmDiff >= 0.4) scoreSahm = 70;
        }

        let scoreYield = 0;
        if(ySpread !== null) {
            if (ySpread < 0) scoreYield = 60;
            else if (ySpread < 0.2) scoreYield = 80;
        }

        let scoreCpi = (!isNaN(cpi) && cpi > 4.0) ? 80 : 0;
        let scoreBuffett = (buffett > 180) ? 90 : 20;
        let scoreFear = (fear > 75) ? 80 : 0;

        if (scoreSahm >= 100) { riskLevel = "CRITICAL"; vetoReason = "è¨å§†è§„åˆ™è§¦å‘ (+0.5%)"; }
        else if (scoreYield >= 80) { riskLevel = "DANGER"; vetoReason = "å€’æŒ‚å›æ­£ (è¡°é€€å‰å…†)"; }
        else if (scoreCpi >= 80) { riskLevel = "DANGER"; vetoReason = "é«˜é€šèƒ€ (>4%)"; }

        if ((riskLevel === "SAFE") && (scoreBuffett > 80 || scoreFear > 80)) {
            riskLevel = "CAUTION";
        }

        const elScore = getEl('globalScore');
        const elAdvice = getEl('positionAdvice');
        const card = getEl('globalScore').parentElement.parentElement.parentElement;

        const totalRisk = (scoreSahm * 0.4) + (scoreYield * 0.2) + (scoreCpi * 0.1) + (scoreBuffett * 0.15) + (scoreFear * 0.15);
        elScore.innerText = Math.round(totalRisk);

        if (riskLevel === "CRITICAL") {
            elScore.style.color = "var(--danger)";
            elAdvice.innerText = `ğŸ”´ ä¸¥é‡ç†”æ–­ï¼š${vetoReason}ã€‚\nå»ºè®®ï¼šç©ºä»“é˜²å¾¡ (0-10%)ï¼Œç»æµè¡°é€€ç¡®è®¤ï¼Œåˆ‡å‹¿æ¥é£åˆ€ã€‚`;
            card.style.borderLeftColor = "var(--danger)";
        } else if (riskLevel === "DANGER") {
            elScore.style.color = "var(--warn)";
            elAdvice.innerText = `ğŸŸ  å±é™©åŒºåŸŸï¼š${vetoReason || "å¤šé‡é£é™©"}ã€‚\nå»ºè®®ï¼šå¤§å¹…å‡ä»“ (20-30%)ï¼Œä¿ç•™æ ¸å¿ƒåº•ä»“ï¼Œåœæ­¢ä¹°å…¥ã€‚`;
            card.style.borderLeftColor = "var(--warn)";
        } else if (riskLevel === "CAUTION") {
            elScore.style.color = "#facc15";
            elAdvice.innerText = "ğŸŸ¡ éœ€è­¦æƒ•ï¼šä¼°å€¼æˆ–æƒ…ç»ªè¿‡çƒ­ã€‚\nå»ºè®®ï¼šä¸­æ€§ä»“ä½ (40-50%)ï¼Œæš‚åœæ¿€è¿›åŠ ä»“ï¼Œç»´æŒå®šæŠ•ã€‚";
            card.style.borderLeftColor = "#facc15";
        } else {
            elScore.style.color = "var(--success)";
            if (fear < 25) {
                elAdvice.innerText = "ğŸ’° é»„é‡‘æœºä¼šï¼šå®è§‚å®‰å…¨ + å¸‚åœºææ…Œã€‚\nå»ºè®®ï¼šé‡ä»“å‡ºå‡» (80%)ï¼Œéåœ°é»„é‡‘ã€‚";
            } else {
                elAdvice.innerText = "ğŸŸ¢ å®è§‚å®‰å…¨ï¼šåŸºæœ¬é¢å¥åº·ã€‚\nå»ºè®®ï¼šæˆé•¿ä»“ä½ (60-70%)ï¼Œç¯å¢ƒæ¸©å’Œï¼ŒæŒ‰ä¸ªè‚¡ä¿¡å·æ“ä½œã€‚";
            }
            card.style.borderLeftColor = "var(--success)";
        }
    }
    
    window.addEventListener('load', function() {
        initChart();
        calculateRisk();
        setTimeout(fetchOfficialData, 1000);
    });
</script>
</body>
</html>
