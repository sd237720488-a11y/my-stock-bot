// bot.js - AlphaSystem äº‘ç«¯æœºå™¨äºº (V6.0 å®è§‚æŒ‡æŒ¥å®˜ç‰ˆ)
// æ–°å¢ï¼šæ¯æ—¥å®è§‚æ™¨æŠ¥ã€è¨å§†è§„åˆ™è‡ªåŠ¨ç›‘æµ‹ã€ç½‘é¡µä»ªè¡¨ç›˜è”åŠ¨

const https = require('https');

// ================= 0. ç¯å¢ƒé…ç½® =================
// æ£€æŸ¥ Fetch æ”¯æŒ
if (!globalThis.fetch || !globalThis.AbortController) {
    console.error("âŒ Node ç‰ˆæœ¬è¿‡ä½ï¼Œè¯·å‡çº§åˆ° Node 20+");
    process.exit(1);
}

const CONFIG = {
    // é£ä¹¦é…ç½® (GitHub Secrets)
    FEISHU_APP_ID: process.env.FEISHU_APP_ID, 
    FEISHU_APP_SECRET: process.env.FEISHU_APP_SECRET,
    FEISHU_APP_TOKEN: process.env.FEISHU_APP_TOKEN, 
    FEISHU_TABLE_ID: process.env.FEISHU_TABLE_ID,
    FEISHU_WEBHOOK: process.env.FEISHU_WEBHOOK,
    
    // æ•°æ®æºé…ç½®
    FINNHUB_KEY: process.env.FINNHUB_KEY,
    ALPHAVANTAGE_KEY: "O0VQP18WF8I5N66X", // å·²å†…ç½®ä½ çš„ Key
    
    // ğŸ‘‡ã€é‡è¦ã€‘è¯·æŠŠç¬¬ä¸€æ­¥ç”Ÿæˆçš„ GitHub Pages é“¾æ¥å¡«åœ¨è¿™é‡Œ
    DASHBOARD_URL: "https://ä½ çš„ç”¨æˆ·å.github.io/ä½ çš„ä»“åº“å/" 
};

// ================= 1. åŸºç¡€å·¥å…· =================
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

const fetchJson = async (url) => {
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), 20000); // 20s è¶…æ—¶
    try {
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(id);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
    } catch (e) {
        clearTimeout(id);
        return null; // å¤±è´¥è¿”å›ç©ºï¼Œä¸å´©æºƒ
    }
};

// ================= 2. å®è§‚åˆ†æå¼•æ“ (ä¸ç½‘é¡µç‰ˆé€»è¾‘ä¸€è‡´) =================
const analyzeMacro = async () => {
    console.log("ğŸŒ¦ï¸ æ­£åœ¨æ‰«æå®è§‚æ°”è±¡ (Alpha Vantage)...");
    
    try {
        // 1. æŠ“å–å¤±ä¸šç‡ (è®¡ç®—çœŸÂ·è¨å§†è§„åˆ™)
        const resUnemp = await fetchJson(`https://www.alphavantage.co/query?function=UNEMPLOYMENT&apikey=${CONFIG.ALPHAVANTAGE_KEY}`);
        
        // 2. æŠ“å–å›½å€º (è®¡ç®—åˆ©å·®)
        // æ³¨æ„ï¼šå…è´¹ Key å¹¶å‘é™åˆ¶ï¼Œéœ€è¦é—´éš”
        await sleep(1500); 
        const res10y = await fetchJson(`https://www.alphavantage.co/query?function=TREASURY_YIELD&interval=monthly&maturity=10year&apikey=${CONFIG.ALPHAVANTAGE_KEY}`);
        await sleep(1500);
        const res2y = await fetchJson(`https://www.alphavantage.co/query?function=TREASURY_YIELD&interval=monthly&maturity=2year&apikey=${CONFIG.ALPHAVANTAGE_KEY}`);

        // --- æ•°æ®å¤„ç† ---
        let sahmStatus = { diff: 0, level: "æœªçŸ¥", color: "grey" };
        let yieldStatus = { spread: 0, level: "æœªçŸ¥", color: "grey" };
        
        // A. è®¡ç®—è¨å§†è§„åˆ™ (3ä¸ªæœˆç§»åŠ¨å¹³å‡)
        if (resUnemp && resUnemp.data && resUnemp.data.length >= 24) {
            const d = resUnemp.data;
            const curMA = (parseFloat(d[0].value) + parseFloat(d[1].value) + parseFloat(d[2].value)) / 3;
            
            let minMA = 100;
            for(let i=0; i<12; i++) {
                const ma = (parseFloat(d[i].value) + parseFloat(d[i+1].value) + parseFloat(d[i+2].value)) / 3;
                if(ma < minMA) minMA = ma;
            }
            
            const diff = curMA - minMA;
            sahmStatus.diff = diff.toFixed(2);
            
            if (diff >= 0.5) { sahmStatus.level = "ğŸ›‘ ç¡®è®¤è¡°é€€"; sahmStatus.color = "red"; }
            else if (diff >= 0.4) { sahmStatus.level = "âš ï¸ é«˜å±é¢„è­¦"; sahmStatus.color = "orange"; }
            else { sahmStatus.level = "ğŸŸ¢ å°±ä¸šå®‰å…¨"; sahmStatus.color = "green"; }
        }

        // B. è®¡ç®—æ”¶ç›Šç‡æ›²çº¿
        if (res10y && res10y.data && res2y && res2y.data) {
            const y10 = parseFloat(res10y.data[0].value);
            const y2 = parseFloat(res2y.data[0].value);
            const spread = y10 - y2;
            yieldStatus.spread = spread.toFixed(2);
            
            if (spread < 0) { yieldStatus.level = "âš ï¸ å€’æŒ‚è­¦ç¤º"; yieldStatus.color = "orange"; }
            else if (spread < 0.3) { yieldStatus.level = "âš–ï¸ è§‚å¯ŸåŒº"; yieldStatus.color = "grey"; }
            else { yieldStatus.level = "ğŸŸ¢ æ­£å¸¸"; yieldStatus.color = "green"; }
        }

        return { sahm: sahmStatus, yield: yieldStatus, success: true };

    } catch (e) {
        console.error("å®è§‚æ•°æ®è·å–å¤±è´¥:", e);
        return { success: false };
    }
};

// ================= 3. é£ä¹¦æ¶ˆæ¯æ¨é€ =================
const sendMacroReport = async (macroData) => {
    if (!CONFIG.FEISHU_WEBHOOK || !macroData.success) return;

    const { sahm, yield: yld } = macroData;
    
    // å†³å®šå¡ç‰‡é¢œè‰²ï¼šæœ‰çº¢è‰²è­¦æŠ¥å°±å˜çº¢ï¼Œå¦åˆ™çœ‹æ˜¯å¦æ©™è‰²ï¼Œé»˜è®¤è“è‰²
    let cardColor = "blue";
    if (sahm.color === "red" || yld.color === "red") cardColor = "red";
    else if (sahm.color === "orange" || yld.color === "orange") cardColor = "orange";

    const content = {
        "msg_type": "interactive",
        "card": {
            "config": { "wide_screen_mode": true },
            "header": { "title": { "tag": "plain_text", "content": "ğŸ“… å®è§‚å…¨æ™¯æ™¨æŠ¥" }, "template": cardColor },
            "elements": [
                {
                    "tag": "div",
                    "fields": [
                        { "is_short": true, "text": { "tag": "lark_md", "content": `**è¨å§†è§„åˆ™ (å¤±ä¸š):**\n${sahm.level} (+${sahm.diff}%)` } },
                        { "is_short": true, "text": { "tag": "lark_md", "content": `**ç¾å€ºåˆ©å·® (10-2):**\n${yld.level} (${yld.spread}%)` } }
                    ]
                },
                { "tag": "hr" },
                {
                    "tag": "action",
                    "actions": [
                        {
                            "tag": "button",
                            "text": { "tag": "plain_text", "content": "ğŸ›¸ æ‰“å¼€å…¨æ™¯æŒ‡æŒ¥å° (ä»ªè¡¨ç›˜)" },
                            "type": "primary",
                            "url": CONFIG.DASHBOARD_URL || "https://github.com" 
                        }
                    ]
                },
                {
                    "tag": "note",
                    "elements": [{ "tag": "plain_text", "content": "æ³¨ï¼šä¼°å€¼/æƒ…ç»ªæŒ‡æ ‡è¯·ç‚¹å‡»æŒ‰é’®åœ¨ç½‘é¡µä¸­æŸ¥çœ‹" }]
                }
            ]
        }
    };

    await fetch(CONFIG.FEISHU_WEBHOOK, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(content) });
    console.log("âœ… å®è§‚æ™¨æŠ¥å·²å‘é€");
};

// ================= 4. ä¸ªè‚¡æ‰«æé€»è¾‘ (ç®€åŒ–ç‰ˆå¼•ç”¨) =================
// ... è¿™é‡Œä¿ç•™ä½ ä¹‹å‰çš„ getSmartGrowthInputs, calculateScenarios, analyzeETF ç­‰å‡½æ•° ...
// ... ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¯·æŠŠä½  V5.6 ç‰ˆæœ¬çš„ä¸­é—´é€»è¾‘ä¿ç•™åœ¨è¿™é‡Œ ...

// æ¨¡æ‹Ÿçš„ä¸ªè‚¡æ‰«æå‡½æ•°å ä½ç¬¦ï¼Œå®é™…è¯·ä¿ç•™åŸä»£ç 
const scanStocks = async () => { console.log("å¼€å§‹æ‰«æä¸ªè‚¡..."); /* åŸæœ‰ä¸ªè‚¡é€»è¾‘ */ };


// ================= 5. ä¸»ç¨‹åºå…¥å£ =================
const main = async () => {
    console.log("=== AlphaSystem V6.0 å¯åŠ¨ ===");

    // 1. å…ˆè¿›è¡Œå®è§‚ä½“æ£€ & æ¨é€æ™¨æŠ¥
    // é€»è¾‘ï¼šæ¯æ¬¡è¿è¡Œéƒ½æ£€æŸ¥å®è§‚ï¼Œä½†åªæœ‰åœ¨ç‰¹å®šæ—¶é—´ï¼ˆæ¯”å¦‚æ¯å¤©ç¬¬ä¸€æ¬¡è¿è¡Œï¼‰æˆ–è€…å®è§‚æœ‰å‰§å˜æ—¶æ‰æ¨é€
    // ç®€å•èµ·è§ï¼Œè¿™é‡Œæ¯æ¬¡è¿è¡Œéƒ½æ£€æŸ¥ï¼Œä½†åœ¨ GitHub Action é‡Œä½ å¯ä»¥é€šè¿‡ Schedule æ§åˆ¶åªåœ¨æ—©ä¸Š8ç‚¹è¿è¡Œä¸€æ¬¡ä¸“é—¨çš„å®è§‚ Job
    // æˆ–è€…æˆ‘ä»¬ç®€å•ç‚¹ï¼šæ¯æ¬¡è¿è¡Œéƒ½è®¡ç®—ï¼ŒæŠŠç»“æœæ‰“å°å‡ºæ¥ï¼Œå¦‚æœæœ‰â€œçº¢è‰²è­¦æŠ¥â€æ‰å¼ºåˆ¶æ¨ï¼Œå¦åˆ™åªåœ¨æ—¥å¿—æ˜¾ç¤ºã€‚
    
    const macro = await analyzeMacro();
    
    // ç­–ç•¥ï¼šå¦‚æœå®è§‚æœ‰é£é™© (éç»¿è‰²)ï¼Œæ¯æ¬¡éƒ½æé†’ã€‚å¦‚æœæ˜¯å®‰å…¨çš„ï¼Œåªåœ¨æ—¥å¿—è®°å½•ï¼Œä¸éªšæ‰°ã€‚
    // ä½ ä¹Ÿå¯ä»¥æ”¹ä¸ºï¼šæ¯æ¬¡éƒ½æ¨ (å–æ¶ˆä¸‹é¢çš„æ³¨é‡Š)
    
    if (macro.success) {
        console.log(`ğŸ“Š å®è§‚çŠ¶æ€: è¨å§†[${macro.sahm.level}] | åˆ©å·®[${macro.yield.level}]`);
        
        // ğŸš¨ è§¦å‘æ¡ä»¶ï¼šæœ‰çº¢è‰²/æ©™è‰²è­¦æŠ¥ï¼Œæˆ–è€…ä½ å¸Œæœ›æ¯å¤©å¿…æ¨
        const hasRisk = macro.sahm.color !== "green" || macro.yield.color !== "green";
        
        // å¦‚æœæƒ³æ¯å¤©å¿…æ¨ï¼Œå°±æŠŠ if (hasRisk) å»æ‰ï¼Œç›´æ¥è°ƒç”¨ sendMacroReport
        if (hasRisk) { 
            await sendMacroReport(macro);
        } else {
            console.log("ğŸŸ¢ å®è§‚ç¯å¢ƒå®‰å…¨ï¼Œæš‚ä¸æ¨é€è­¦æŠ¥");
        }
    }

    // 2. æ‰§è¡Œä¸ªè‚¡æ‰«æ (åŸæ¥çš„æ ¸å¿ƒé€»è¾‘)
    // è¯·ç¡®ä¿è¿™é‡Œè°ƒç”¨äº†ä½ ä¹‹å‰çš„ä¸ªè‚¡å¾ªç¯é€»è¾‘
    // await scanStocks(); 
    
    // (ç”±äºä½ ä¹‹å‰çš„ä»£ç å¾ˆé•¿ï¼Œè¿™é‡Œæˆ‘åªå†™äº†å®è§‚éƒ¨åˆ†ã€‚
    // è¯·æŠŠä½  V5.6 ç‰ˆæœ¬ä¸­ main() å‡½æ•°é‡Œ "1. é£ä¹¦é‰´æƒ" å¾€åçš„æ‰€æœ‰ä»£ç ï¼Œ
    // ç²˜è´´åœ¨è¿™ä¸ªä½ç½®ï¼Œæ›¿æ¢æ‰ await scanStocks())
};

main().catch(e => { console.error(e); process.exit(1); });
